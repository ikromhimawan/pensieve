import React, { useEffect, useMemo, useState } from "react";
import Head from "next/head";
import styles from '../../styles/Home.module.css'
import Image from "next/image";
import Box from '@mui/material/Box';
import Grid from '@mui/material/Grid';
import { useRouter } from "next/router";
import { fetchApi } from "../../helper/api";
import { decript } from "../../helper/function";
import DataTable from "react-data-table-component";
import { ChartPie } from "../../component/ChartPie";
import Button from '@mui/material/Button';
import KeyboardArrowLeftIcon from '@mui/icons-material/KeyboardArrowLeft';
import { IsAlert } from "../../component/IsAlert";

const Home = () => {
    const router = useRouter()
    const [data, setData] = useState()
    useEffect(() => {
        if (router.query.id) {
            getdata()
        }
    }, [router])

    const getdata = async () => {
        var res = await fetchApi(decript(router.query.id), "get", true)
        if (res.status == 200) {
            setData(res.data)
        }
        else {
            IsAlert.fire({
                title: "",
                text: res.data.response.message,
                icon: "error",
                showCancelButton: false,
                focusConfirm: false,
                confirmButtonText: 'Go to Login',

            }).then(async function (isConfirm) {
                if (isConfirm.isConfirmed) {
                    router.push('/')
                }
            })
        }
    }
    const columns = useMemo(
        () => [
            {
                name: "Latest Timestamp",
                cell: data => data.timestamp,
                sortable: true,
            },
            {
                name: "Latest Location",
                cell: data => data.location,
                width: "7rem"
            }
        ],
        []
    );
    const groupBy = (array, key) => {
        return array.reduce((result, currentValue) => {
            (result[currentValue[key]] = result[currentValue[key]] || []).push(
                currentValue
            );
            return result;
        }, {});
    };
    const hitungPersen = () => {
        var total = data.length
        var dataSource = groupBy(data, "location")
        var dataPersentase = []
        Object.entries(dataSource).map((e) => {
            var jumlah = e[1].length / total
            var hasil = jumlah * 100
            dataPersentase.push({
                name: e[0],
                persen: hasil
            })
        })
        return dataPersentase
    }
    const viewPersen = () => {
        var dataPercent = hitungPersen()
        console.log(dataPercent);
        return (
            dataPercent.map((e) => {
                return (
                    <li>{e.name} <b>{e.persen}%</b></li>
                )
            })

        )
    }
    return (
        <>
            <Head>
                <title>Dashboard - Pensieve</title>
                <meta name="description" content="Generated by create next app" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <div className="btn-back">
                <Button className={styles.thirteen} variant="outlined" startIcon={<KeyboardArrowLeftIcon />} onClick={() => router.push("/home")}>
                    Back
                </Button>
            </div>
            <main className={styles.mainHome}>

                <div className={styles.center}>
                    <Image
                        className={styles.logo}
                        src="/pensieve.svg"
                        alt="Next.js Logo"
                        width={180}
                        height={37}
                        priority
                    />
                </div>
                <Box sx={{ flexGrow: 1 }} >
                    <Grid
                        spacing={2}
                        container
                        direction="row"
                        justifyContent="center"
                        alignItems="center">
                        <Grid item xs={4}>
                            <div className={`${styles.thirteen} ${styles.kiri}`}>
                                <div className="inset-0" style={{ padding: '20px' }}>
                                    {
                                        data && <DataTable
                                            columns={columns}
                                            data={data}
                                            // pagination
                                            className="text-white"
                                        />
                                    }
                                </div>
                            </div>
                        </Grid>
                        <Grid item xs={8}>
                            <div className={`${styles.thirteen} ${styles.kiri}`}>
                                <Grid
                                    spacing={2}
                                    container
                                    direction="row"
                                    justifyContent="center"
                                    alignItems="center">
                                    <Grid item xs={4}>
                                        {
                                            data && <ChartPie data={data} />
                                        }
                                    </Grid>
                                    <Grid item xs={4}>
                                        <h3>% Time spent on each location</h3>
                                        <ul style={{ paddingLeft: "2rem", marginTop: '1rem' }}>
                                            {
                                                data && viewPersen()
                                            }
                                        </ul>
                                    </Grid>
                                </Grid>
                            </div>
                        </Grid>
                    </Grid>
                </Box>
            </main>
        </>
    )
}
export default Home